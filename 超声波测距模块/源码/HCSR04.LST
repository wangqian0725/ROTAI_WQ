C51 COMPILER V7.10   HCSR04                                                                04/15/2016 21:28:15 PAGE 1   


C51 COMPILER V7.10, COMPILATION OF MODULE HCSR04
OBJECT MODULE PLACED IN HCSR04.OBJ
COMPILER INVOKED BY: d:\program files\Keil\C51\BIN\C51.EXE HCSR04.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "HCSR04.h"
   2          #include "coon.h"
   3          #include <reg52.h>
   4          
   5          sbit echo_HCSR04=P1^5;
   6          sbit trig_HCSR04=P1^4;
   7          bit  flag_HCSR04=0;
   8          
   9          /*********************************************************************
  10           原型: float read_HCSR04()
  11           功能: 执行一次距离测量,并返回测量结果
  12           返回: 测量到的距离, 单位为厘米
  13          *********************************************************************/
  14          float read_HCSR04()
  15          {
  16   1              float s=0.0;
  17   1      
  18   1              TMOD = (TMOD & 0xF0) | 0x01;
  19   1              ET0 = 1;  //允许T0中断
  20   1              TH0 = 0;
  21   1              TL0 = 0;
  22   1      
  23   1              trig_HCSR04 = 1;
  24   1              delay_20us();
  25   1              trig_HCSR04 = 0;
  26   1              
  27   1              while(!echo_HCSR04);   //当RX为零时等待
  28   1              TR0=1;                 //开启计数
  29   1              while(echo_HCSR04);    //当RX为1计数并等待
  30   1              TR0=0;                 //关闭计数
  31   1      
  32   1              if(flag_HCSR04 == 0)         //超出测量
  33   1              {
  34   2                      s = ((TH0*256+TL0)*1.87)/100;  //算出来是CM
  35   2                      if( s < 10 ) 
  36   2                              s = s - 0.4;
  37   2                      else if( s < 20 )
  38   2                              s = s - 0.8;
  39   2              }
  40   1              else
  41   1              {
  42   2                      flag_HCSR04 = 0;
  43   2              }
  44   1              return s;
  45   1      }
  46          
  47          /*********************************************************************
  48           原型: float get_HCSR04()
  49           功能: 将9次测量结果排序,取中间1次
  50          *********************************************************************/
  51          float get_HCSR04()
  52          {
  53   1              int i=0, j=0, m=0;
  54   1              float xdata dat[9]={0};
  55   1      
C51 COMPILER V7.10   HCSR04                                                                04/15/2016 21:28:15 PAGE 2   

  56   1              for(i=0; i<9; i++)
  57   1              {
  58   2                      dat[i] = read_HCSR04();
  59   2                      delay_ms(20);
  60   2              }
  61   1      
  62   1              for(i=0; i<8; i++)
  63   1              {
  64   2                      for(j=i; j<9; j++)
  65   2                      {
  66   3                              if( dat[j] < dat[i] )
  67   3                              {
  68   4                                      m = dat[i];
  69   4                                      dat[i] = dat[j];
  70   4                                      dat[j] = m;
  71   4                              }
  72   3                      }
  73   2              }       
  74   1              return dat[4];
  75   1      }
  76          
  77          /*********************************************************************
  78           原型: void interrupt_HCSR04()
  79           功能: 中断程序, 测量失败时触发
  80          *********************************************************************/
  81          void interrupt_HCSR04() interrupt 1
  82          {
  83   1              flag_HCSR04 = 1; //中断溢出标志
  84   1      }
  85          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    627    ----
   CONSTANT SIZE    =     36    ----
   XDATA SIZE       =   ----      36
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
